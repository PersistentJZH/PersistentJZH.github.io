---
title: åŸåœ°å‡çº§
createTime: 2025/11/03 20:27:16
permalink: /k8s/er3d3vot/
---

# OpenKruise åŸåœ°å‡çº§ï¼ˆIn-Place Updateï¼‰åŸç†è¯¦è§£

## ä»€ä¹ˆæ˜¯åŸåœ°å‡çº§

åŸåœ°å‡çº§ï¼ˆIn-Place Updateï¼‰æ˜¯ OpenKruise æä¾›çš„ä¸€ç§ Pod å‡çº§ç­–ç•¥ï¼Œå®ƒèƒ½å¤Ÿåœ¨ä¸åˆ é™¤ Pod çš„æƒ…å†µä¸‹æ›´æ–°å®¹å™¨é•œåƒå’Œå…¶ä»–ç‰¹å®šå­—æ®µã€‚ä¸ Kubernetes åŸç”Ÿçš„é‡å»ºå¼å‡çº§ç›¸æ¯”ï¼ŒåŸåœ°å‡çº§å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

### ä¼ ç»Ÿé‡å»ºå¼å‡çº§ vs åŸåœ°å‡çº§

| ç‰¹æ€§ | ä¼ ç»Ÿé‡å»ºå¼å‡çº§ | åŸåœ°å‡çº§ |
|------|--------------|----------|
| Pod åç§° | æ”¹å˜ï¼ˆé‡æ–°åˆ›å»ºï¼‰ | ä¸å˜ |
| Pod UID | æ”¹å˜ | ä¸å˜ |
| Pod IP | æ”¹å˜ | ä¸å˜ |
| å‡çº§é€Ÿåº¦ | è¾ƒæ…¢ï¼ˆéœ€è¦è°ƒåº¦ã€æ‹‰é•œåƒï¼‰ | è¾ƒå¿«ï¼ˆä»…é‡å¯å®¹å™¨ï¼‰ |
| æ•°æ®å· | éœ€è¦é‡æ–°æŒ‚è½½ | ä¿æŒæŒ‚è½½ |
| ç½‘ç»œè¿æ¥ | ä¸­æ–­ | éƒ¨åˆ†åœºæ™¯å¯ä¿æŒ |
| èµ„æºé¢„ç•™ | å¯èƒ½è¢«å…¶ä»– Pod å ç”¨ | å§‹ç»ˆä¿ç•™ |

## æ ¸å¿ƒåŸç†

### 1. Pod æ›´æ–°æœºåˆ¶

OpenKruise é€šè¿‡æ‰©å±• Kubernetes çš„ Pod è§„èŒƒï¼Œæ·»åŠ äº†ç‰¹æ®Šçš„æ³¨è§£å’Œæ ‡ç­¾æ¥æ§åˆ¶åŸåœ°å‡çº§è¿‡ç¨‹ï¼š

#### å…³é”®æ³¨è§£ï¼ˆAnnotationsï¼‰

```yaml
metadata:
  annotations:
    # æ ‡è®° Pod éœ€è¦åŸåœ°å‡çº§
    apps.kruise.io/inplace-update-state: '{"containerImages":{"nginx":"nginx:1.19"}}'
    
    # è®°å½•åŸåœ°å‡çº§çš„ç‰ˆæœ¬
    apps.kruise.io/inplace-update-grace: '{"revision":"cloneset-abc123","containerImages":{"nginx":"nginx:1.19"}}'
```

### 2. æ›´æ–°æµç¨‹

åŸåœ°å‡çº§çš„å®Œæ•´æµç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åŸåœ°å‡çº§æµç¨‹                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. PreCheck é˜¶æ®µ
   â”œâ”€ æ£€æŸ¥ Pod æ˜¯å¦æ»¡è¶³åŸåœ°å‡çº§æ¡ä»¶
   â”œâ”€ æ£€æŸ¥æ›´æ–°çš„å­—æ®µæ˜¯å¦æ”¯æŒï¼ˆé•œåƒã€ç¯å¢ƒå˜é‡ç­‰ï¼‰
   â””â”€ éªŒè¯ Pod çŠ¶æ€æ˜¯å¦å¥åº·

2. Prepare é˜¶æ®µ
   â”œâ”€ ç»™ Pod æ·»åŠ åŸåœ°å‡çº§æ³¨è§£
   â”œâ”€ æ ‡è®° Pod ä¸º NotReadyï¼ˆä» Service Endpoints æ‘˜é™¤ï¼‰
   â””â”€ ç­‰å¾… gracePeriodï¼ˆä¼˜é›…ç»ˆæ­¢æ—¶é—´ï¼‰

3. Update é˜¶æ®µ
   â”œâ”€ æ›´æ–° Pod Spec ä¸­çš„ç›®æ ‡å­—æ®µ
   â”‚  â”œâ”€ å®¹å™¨é•œåƒ
   â”‚  â”œâ”€ ç¯å¢ƒå˜é‡
   â”‚  â””â”€ èµ„æºé™åˆ¶ï¼ˆéƒ¨åˆ†æ”¯æŒï¼‰
   â”œâ”€ Kubelet æ£€æµ‹åˆ° Pod Spec å˜åŒ–
   â””â”€ Kubelet é‡å¯å—å½±å“çš„å®¹å™¨

4. PostCheck é˜¶æ®µ
   â”œâ”€ ç­‰å¾…å®¹å™¨é‡å¯å®Œæˆ
   â”œâ”€ æ£€æŸ¥å®¹å™¨å¥åº·æ£€æŸ¥
   â”œâ”€ ç§»é™¤åŸåœ°å‡çº§æ³¨è§£
   â””â”€ æ¢å¤ Pod ä¸º Ready çŠ¶æ€
```

### 3. æŠ€æœ¯å®ç°ç»†èŠ‚

#### 3.1 Kubelet çš„å®¹å™¨é‡å¯æœºåˆ¶

åŸåœ°å‡çº§åˆ©ç”¨äº† Kubelet çš„ç°æœ‰èƒ½åŠ›ã€‚å½“ Pod Spec ä¸­çš„å®¹å™¨é•œåƒå‘ç”Ÿå˜åŒ–æ—¶ï¼ŒKubelet ä¼šï¼š

```go
// Kubelet æ£€æµ‹ Pod Spec å˜åŒ–çš„ä¼ªä»£ç 
func (kl *Kubelet) syncPod(pod *v1.Pod) error {
    // 1. è·å– Pod çš„å½“å‰çŠ¶æ€
    podStatus := kl.statusManager.GetPodStatus(pod.UID)
    
    // 2. æ¯”è¾ƒæœŸæœ›çŠ¶æ€å’Œå½“å‰çŠ¶æ€
    for _, container := range pod.Spec.Containers {
        currentContainer := findContainer(podStatus, container.Name)
        
        // 3. å¦‚æœé•œåƒä¸åŒï¼Œåœæ­¢å¹¶é‡å¯å®¹å™¨
        if currentContainer.Image != container.Image {
            // åœæ­¢æ—§å®¹å™¨
            kl.containerRuntime.KillContainer(currentContainer.ID, gracePeriod)
            
            // æ‹‰å–æ–°é•œåƒ
            imageRef := kl.imagePuller.EnsureImageExists(container.Image)
            
            // å¯åŠ¨æ–°å®¹å™¨
            kl.containerRuntime.StartContainer(pod, container, imageRef)
        }
    }
    
    return nil
}
```

#### 3.2 å¯åŸåœ°å‡çº§çš„å­—æ®µ

OpenKruise æ”¯æŒåŸåœ°å‡çº§ä»¥ä¸‹å­—æ®µï¼š

```yaml
# âœ… æ”¯æŒåŸåœ°å‡çº§çš„å­—æ®µ
spec:
  containers:
  - name: app
    image: nginx:1.19  # âœ… å®¹å™¨é•œåƒ
    env:               # âœ… ç¯å¢ƒå˜é‡
    - name: LOG_LEVEL
      value: "info"
    resources:         # âš ï¸ éƒ¨åˆ†æ”¯æŒï¼ˆéœ€è¦ Kubernetes 1.27+ï¼‰
      limits:
        cpu: "2"
        memory: "2Gi"

# âŒ ä¸æ”¯æŒåŸåœ°å‡çº§çš„å­—æ®µ
spec:
  volumes:           # âŒ æ•°æ®å·å®šä¹‰
  nodeSelector:      # âŒ èŠ‚ç‚¹é€‰æ‹©å™¨
  affinity:          # âŒ äº²å’Œæ€§é…ç½®
  serviceAccountName: # âŒ æœåŠ¡è´¦å·
```

### 4. çŠ¶æ€æœºæ¨¡å‹

åŸåœ°å‡çº§è¿‡ç¨‹ä¸­ï¼ŒPod ä¼šç»å†å¤šä¸ªçŠ¶æ€ï¼š

```go
type InPlaceUpdateState string

const (
    // æ— éœ€æ›´æ–°
    InPlaceUpdateStateNone InPlaceUpdateState = ""
    
    // å‡†å¤‡é˜¶æ®µï¼šä» Service æ‘˜é™¤ï¼Œç­‰å¾…ä¼˜é›…ä¸‹çº¿
    InPlaceUpdateStatePreparing InPlaceUpdateState = "Preparing"
    
    // æ›´æ–°é˜¶æ®µï¼šæ­£åœ¨æ›´æ–°å®¹å™¨
    InPlaceUpdateStateUpdating InPlaceUpdateState = "Updating"
    
    // å®Œæˆé˜¶æ®µï¼šå®¹å™¨æ›´æ–°å®Œæˆï¼Œç­‰å¾…å¥åº·æ£€æŸ¥
    InPlaceUpdateStateUpdated InPlaceUpdateState = "Updated"
)
```

çŠ¶æ€è½¬æ¢å›¾ï¼š

```
     â”Œâ”€â”€â”€â”€â”€â”€â”
     â”‚ None â”‚
     â””â”€â”€â”€â”¬â”€â”€â”˜
         â”‚ è§¦å‘æ›´æ–°
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Preparing   â”‚  (NotReady, ä¼˜é›…ä¸‹çº¿)
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ gracePeriod ç»“æŸ
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Updating   â”‚  (æ›´æ–° Pod Spec)
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ å®¹å™¨é‡å¯å®Œæˆ
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Updated    â”‚  (ç­‰å¾…å¥åº·æ£€æŸ¥)
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ å¥åº·æ£€æŸ¥é€šè¿‡
         â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”
     â”‚ None â”‚  (Ready, åŠ å…¥ Service)
     â””â”€â”€â”€â”€â”€â”€â”˜
```

## å®é™…æ¨¡æ‹ŸåŸåœ°å‡çº§è¿‡ç¨‹

ä¸‹é¢æˆ‘ä»¬é€šè¿‡å®é™…æ“ä½œæ¥æ¨¡æ‹Ÿ OpenKruise çš„åŸåœ°å‡çº§è¿‡ç¨‹ã€‚

### ç¯å¢ƒå‡†å¤‡

#### 1. å®‰è£… OpenKruise

```bash
# ä½¿ç”¨ Helm å®‰è£…
helm repo add openkruise https://openkruise.github.io/charts/
helm repo update
helm install kruise openkruise/kruise --version 1.5.0

# éªŒè¯å®‰è£…
kubectl get pods -n kruise-system
```

#### 2. åˆ›å»ºæµ‹è¯• CloneSet

```yaml
# cloneset-demo.yaml
apiVersion: apps.kruise.io/v1alpha1
kind: CloneSet
metadata:
  name: nginx-demo
  labels:
    app: nginx-demo
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx-demo
  # å…³é”®ï¼šé…ç½®åŸåœ°å‡çº§ç­–ç•¥
  updateStrategy:
    type: InPlaceIfPossible  # å°½å¯èƒ½ä½¿ç”¨åŸåœ°å‡çº§
    inPlaceUpdateStrategy:
      gracePeriodSeconds: 10  # ä¼˜é›…ä¸‹çº¿æ—¶é—´
    maxUnavailable: 1         # æœ€å¤šåŒæ—¶æ›´æ–° 1 ä¸ª Pod
  template:
    metadata:
      labels:
        app: nginx-demo
    spec:
      containers:
      - name: nginx
        image: nginx:1.19.0  # åˆå§‹ç‰ˆæœ¬
        ports:
        - containerPort: 80
        env:
        - name: VERSION
          value: "v1.0"
        # å¥åº·æ£€æŸ¥
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 3
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 5
        # ç”Ÿå‘½å‘¨æœŸé’©å­
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "sleep 5"]
```

åº”ç”¨é…ç½®ï¼š

```bash
kubectl apply -f cloneset-demo.yaml
```

### ç›‘æ§å’Œè§‚å¯Ÿ

#### 1. å‡†å¤‡ç›‘æ§è„šæœ¬

åˆ›å»ºä¸€ä¸ªå®æ—¶ç›‘æ§è„šæœ¬æ¥è§‚å¯ŸåŸåœ°å‡çº§è¿‡ç¨‹ï¼š

```bash
# monitor.sh
#!/bin/bash

echo "å¼€å§‹ç›‘æ§ CloneSet åŸåœ°å‡çº§è¿‡ç¨‹..."
echo "=================================="

# æŒç»­ç›‘æ§
watch -n 1 '
echo "=== CloneSet çŠ¶æ€ ==="
kubectl get cloneset nginx-demo -o wide

echo ""
echo "=== Pod åˆ—è¡¨ï¼ˆæ³¨æ„ Pod åç§°ã€IPã€å¹´é¾„ï¼‰ ==="
kubectl get pods -l app=nginx-demo -o custom-columns=\
NAME:.metadata.name,\
STATUS:.status.phase,\
IP:.status.podIP,\
READY:.status.conditions[?\(@.type==\"Ready\"\)].status,\
AGE:.metadata.creationTimestamp,\
IMAGE:.spec.containers[0].image

echo ""
echo "=== åŸåœ°å‡çº§æ³¨è§£ ==="
kubectl get pods -l app=nginx-demo -o jsonpath="{range .items[*]}{.metadata.name}{\": \"}{.metadata.annotations.apps\.kruise\.io/inplace-update-state}{\"\\n\"}{end}"

echo ""
echo "=== å®¹å™¨é‡å¯æ¬¡æ•° ==="
kubectl get pods -l app=nginx-demo -o custom-columns=\
NAME:.metadata.name,\
RESTARTS:.status.containerStatuses[0].restartCount
'
```

è¿è¡Œç›‘æ§ï¼š

```bash
chmod +x monitor.sh
./monitor.sh
```

#### 2. è¯¦ç»†äº‹ä»¶ç›‘æ§

åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­ç›‘æ§äº‹ä»¶ï¼š

```bash
kubectl get events --watch --field-selector involvedObject.kind=Pod -n default
```

### æ‰§è¡ŒåŸåœ°å‡çº§

#### æ–¹å¼ 1ï¼šæ›´æ–°é•œåƒç‰ˆæœ¬

```bash
# æ›´æ–°åˆ° nginx:1.20.0
kubectl patch cloneset nginx-demo --type='merge' -p='{
  "spec": {
    "template": {
      "spec": {
        "containers": [{
          "name": "nginx",
          "image": "nginx:1.20.0"
        }]
      }
    }
  }
}'
```

#### æ–¹å¼ 2ï¼šæ›´æ–°ç¯å¢ƒå˜é‡

```bash
# æ›´æ–°ç¯å¢ƒå˜é‡
kubectl patch cloneset nginx-demo --type='merge' -p='{
  "spec": {
    "template": {
      "spec": {
        "containers": [{
          "name": "nginx",
          "env": [{
            "name": "VERSION",
            "value": "v2.0"
          }]
        }]
      }
    }
  }
}'
```

### è§‚å¯Ÿå‡çº§è¿‡ç¨‹

åœ¨ç›‘æ§çª—å£ä¸­ï¼Œä½ ä¼šçœ‹åˆ°ä»¥ä¸‹è¿‡ç¨‹ï¼š

#### é˜¶æ®µ 1ï¼šPreparingï¼ˆå‡†å¤‡é˜¶æ®µï¼‰

```
NAME                    STATUS    IP            READY   AGE                    IMAGE
nginx-demo-abc123      Running   10.244.1.10   False   2023-11-03T10:00:00Z   nginx:1.19.0
nginx-demo-def456      Running   10.244.1.11   True    2023-11-03T10:00:00Z   nginx:1.19.0
nginx-demo-ghi789      Running   10.244.1.12   True    2023-11-03T10:00:00Z   nginx:1.19.0

# æ³¨è§£æ˜¾ç¤º
nginx-demo-abc123: {"revision":"nginx-demo-v2","containerImages":{"nginx":"nginx:1.20.0"},"state":"Preparing"}
```

**å…³é”®è§‚å¯Ÿç‚¹ï¼š**
- âœ… Pod åç§°æ²¡æœ‰æ”¹å˜ï¼ˆ`nginx-demo-abc123`ï¼‰
- âœ… Pod IP æ²¡æœ‰æ”¹å˜ï¼ˆ`10.244.1.10`ï¼‰
- âš ï¸ READY çŠ¶æ€å˜ä¸º `False`ï¼ˆä» Service æ‘˜é™¤ï¼‰
- ğŸ“ å‡ºç°åŸåœ°å‡çº§æ³¨è§£

#### é˜¶æ®µ 2ï¼šUpdatingï¼ˆæ›´æ–°é˜¶æ®µï¼‰

```
NAME                    STATUS    IP            READY   AGE                    IMAGE
nginx-demo-abc123      Running   10.244.1.10   False   2023-11-03T10:00:00Z   nginx:1.20.0
nginx-demo-def456      Running   10.244.1.11   True    2023-11-03T10:00:00Z   nginx:1.19.0
nginx-demo-ghi789      Running   10.244.1.12   True    2023-11-03T10:00:00Z   nginx:1.19.0

# æ³¨è§£æ˜¾ç¤º
nginx-demo-abc123: {"revision":"nginx-demo-v2","containerImages":{"nginx":"nginx:1.20.0"},"state":"Updating"}
```

**å…³é”®è§‚å¯Ÿç‚¹ï¼š**
- âœ… é•œåƒå·²æ›´æ–°ä¸º `nginx:1.20.0`
- âœ… Pod ä»åœ¨è¿è¡Œä¸­
- ğŸ“Š å®¹å™¨é‡å¯æ¬¡æ•°å¢åŠ 

#### é˜¶æ®µ 3ï¼šUpdatedï¼ˆå®Œæˆé˜¶æ®µï¼‰

```
NAME                    STATUS    IP            READY   AGE                    IMAGE
nginx-demo-abc123      Running   10.244.1.10   True    2023-11-03T10:00:00Z   nginx:1.20.0
nginx-demo-def456      Running   10.244.1.11   True    2023-11-03T10:00:00Z   nginx:1.19.0
nginx-demo-ghi789      Running   10.244.1.12   True    2023-11-03T10:00:00Z   nginx:1.19.0

# æ³¨è§£å·²ç§»é™¤
nginx-demo-abc123: 
```

**å…³é”®è§‚å¯Ÿç‚¹ï¼š**
- âœ… READY çŠ¶æ€æ¢å¤ä¸º `True`
- âœ… åŸåœ°å‡çº§æ³¨è§£è¢«ç§»é™¤
- âœ… Pod é‡æ–°åŠ å…¥ Service Endpoints

### éªŒè¯åŸåœ°å‡çº§æ•ˆæœ

#### 1. éªŒè¯ Pod èº«ä»½ä¸å˜

```bash
# è®°å½•å‡çº§å‰çš„ Pod ä¿¡æ¯
kubectl get pods -l app=nginx-demo -o custom-columns=\
NAME:.metadata.name,\
UID:.metadata.uid,\
IP:.status.podIP > before-upgrade.txt

# æ‰§è¡Œå‡çº§...

# è®°å½•å‡çº§åçš„ Pod ä¿¡æ¯
kubectl get pods -l app=nginx-demo -o custom-columns=\
NAME:.metadata.name,\
UID:.metadata.uid,\
IP:.status.podIP > after-upgrade.txt

# å¯¹æ¯”
diff before-upgrade.txt after-upgrade.txt
```

**é¢„æœŸç»“æœï¼š** æ— å·®å¼‚ï¼ˆPod åç§°ã€UIDã€IP å®Œå…¨ç›¸åŒï¼‰

#### 2. éªŒè¯é•œåƒå·²æ›´æ–°

```bash
kubectl get pods -l app=nginx-demo -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[0].image}{"\n"}{end}'
```

**é¢„æœŸè¾“å‡ºï¼š**
```
nginx-demo-abc123    nginx:1.20.0
nginx-demo-def456    nginx:1.20.0
nginx-demo-ghi789    nginx:1.20.0
```

#### 3. éªŒè¯å®¹å™¨é‡å¯

```bash
kubectl get pods -l app=nginx-demo -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.containerStatuses[0].restartCount}{"\n"}{end}'
```

**é¢„æœŸè¾“å‡ºï¼š**
```
nginx-demo-abc123    1
nginx-demo-def456    1
nginx-demo-ghi789    1
```

## æ·±å…¥åˆ†æï¼šæºç çº§åˆ«çš„ç†è§£

### 1. CloneSet Controller çš„æ ¸å¿ƒé€»è¾‘

```go
// pkg/controller/cloneset/sync/cloneset_update.go

func (r *ReconcileCloneSet) updatePods(cloneSet *appsv1alpha1.CloneSet, pods []*v1.Pod) error {
    // 1. è®¡ç®—éœ€è¦æ›´æ–°çš„ Pods
    podsToUpdate := r.getPodsToUpdate(cloneSet, pods)
    
    for _, pod := range podsToUpdate {
        // 2. æ£€æŸ¥æ˜¯å¦å¯ä»¥åŸåœ°å‡çº§
        if canInPlaceUpdate(pod, cloneSet.Spec.Template) {
            // 3. æ‰§è¡ŒåŸåœ°å‡çº§
            if err := r.inPlaceUpdatePod(pod, cloneSet); err != nil {
                return err
            }
        } else {
            // 4. å›é€€åˆ°é‡å»ºå¼å‡çº§
            if err := r.recreatePod(pod); err != nil {
                return err
            }
        }
    }
    
    return nil
}

func (r *ReconcileCloneSet) inPlaceUpdatePod(pod *v1.Pod, cloneSet *appsv1alpha1.CloneSet) error {
    // è·å–å½“å‰åŸåœ°å‡çº§çŠ¶æ€
    state := inplaceupdate.GetInPlaceUpdateState(pod)
    
    switch state {
    case inplaceupdate.InPlaceUpdateStateNone:
        // é˜¶æ®µ 1ï¼šå¼€å§‹åŸåœ°å‡çº§ï¼Œè®¾ç½®ä¸º Preparing
        return r.prepareInPlaceUpdate(pod, cloneSet)
        
    case inplaceupdate.InPlaceUpdateStatePreparing:
        // é˜¶æ®µ 2ï¼šæ£€æŸ¥ gracePeriod æ˜¯å¦ç»“æŸ
        if time.Now().After(state.GraceStartTime.Add(gracePeriod)) {
            return r.executeInPlaceUpdate(pod, cloneSet)
        }
        return nil
        
    case inplaceupdate.InPlaceUpdateStateUpdating:
        // é˜¶æ®µ 3ï¼šç­‰å¾…å®¹å™¨é‡å¯å®Œæˆ
        if allContainersReady(pod) {
            return r.completeInPlaceUpdate(pod)
        }
        return nil
    }
    
    return nil
}

func (r *ReconcileCloneSet) prepareInPlaceUpdate(pod *v1.Pod, cloneSet *appsv1alpha1.CloneSet) error {
    // 1. æ·»åŠ åŸåœ°å‡çº§æ³¨è§£
    if pod.Annotations == nil {
        pod.Annotations = make(map[string]string)
    }
    
    updateState := &inplaceupdate.InPlaceUpdateState{
        Revision:        cloneSet.Status.UpdateRevision,
        ContainerImages: getNewContainerImages(cloneSet),
        State:           "Preparing",
        GraceStartTime:  time.Now(),
    }
    
    data, _ := json.Marshal(updateState)
    pod.Annotations[inplaceupdate.InPlaceUpdateStateKey] = string(data)
    
    // 2. è®¾ç½® Pod ä¸º NotReadyï¼ˆé€šè¿‡æ·»åŠ  ReadinessGateï¼‰
    pod.Spec.ReadinessGates = append(pod.Spec.ReadinessGates, v1.PodReadinessGate{
        ConditionType: inplaceupdate.InPlaceUpdateReady,
    })
    
    // 3. æ›´æ–° Pod
    return r.Client.Update(context.TODO(), pod)
}

func (r *ReconcileCloneSet) executeInPlaceUpdate(pod *v1.Pod, cloneSet *appsv1alpha1.CloneSet) error {
    // 1. æ›´æ–° Pod Spec ä¸­çš„å®¹å™¨é•œåƒ
    for i, container := range pod.Spec.Containers {
        newImage := getNewImage(cloneSet, container.Name)
        if newImage != "" {
            pod.Spec.Containers[i].Image = newImage
        }
    }
    
    // 2. æ›´æ–°åŸåœ°å‡çº§çŠ¶æ€ä¸º Updating
    updateState := getInPlaceUpdateState(pod)
    updateState.State = "Updating"
    data, _ := json.Marshal(updateState)
    pod.Annotations[inplaceupdate.InPlaceUpdateStateKey] = string(data)
    
    // 3. æ›´æ–° Podï¼ˆè§¦å‘ Kubelet é‡å¯å®¹å™¨ï¼‰
    return r.Client.Update(context.TODO(), pod)
}

func (r *ReconcileCloneSet) completeInPlaceUpdate(pod *v1.Pod) error {
    // 1. ç§»é™¤åŸåœ°å‡çº§æ³¨è§£
    delete(pod.Annotations, inplaceupdate.InPlaceUpdateStateKey)
    
    // 2. ç§»é™¤ ReadinessGate
    pod.Spec.ReadinessGates = removeReadinessGate(pod.Spec.ReadinessGates, 
                                                   inplaceupdate.InPlaceUpdateReady)
    
    // 3. æ›´æ–° Pod
    return r.Client.Update(context.TODO(), pod)
}
```

### 2. åˆ¤æ–­æ˜¯å¦å¯ä»¥åŸåœ°å‡çº§çš„é€»è¾‘

```go
func canInPlaceUpdate(oldPod *v1.Pod, newTemplate *v1.PodTemplateSpec) bool {
    oldSpec := &oldPod.Spec
    newSpec := &newTemplate.Spec
    
    // æ£€æŸ¥ä¸å¯åŸåœ°å‡çº§çš„å­—æ®µ
    checks := []struct {
        name  string
        equal bool
    }{
        {"Volumes", apiequality.Semantic.DeepEqual(oldSpec.Volumes, newSpec.Volumes)},
        {"InitContainers", canUpdateInitContainers(oldSpec.InitContainers, newSpec.InitContainers)},
        {"EphemeralContainers", apiequality.Semantic.DeepEqual(oldSpec.EphemeralContainers, newSpec.EphemeralContainers)},
        {"Overhead", apiequality.Semantic.DeepEqual(oldSpec.Overhead, newSpec.Overhead)},
        {"Affinity", apiequality.Semantic.DeepEqual(oldSpec.Affinity, newSpec.Affinity)},
        {"NodeSelector", apiequality.Semantic.DeepEqual(oldSpec.NodeSelector, newSpec.NodeSelector)},
        {"ServiceAccountName", oldSpec.ServiceAccountName == newSpec.ServiceAccountName},
    }
    
    for _, check := range checks {
        if !check.equal {
            klog.V(4).Infof("Cannot in-place update because %s changed", check.name)
            return false
        }
    }
    
    // æ£€æŸ¥å®¹å™¨æ›´æ–°
    for i := range newSpec.Containers {
        oldContainer := findContainer(oldSpec.Containers, newSpec.Containers[i].Name)
        if oldContainer == nil {
            return false  // æ–°å¢å®¹å™¨ä¸æ”¯æŒåŸåœ°å‡çº§
        }
        
        if !canUpdateContainer(oldContainer, &newSpec.Containers[i]) {
            return false
        }
    }
    
    return true
}

func canUpdateContainer(old, new *v1.Container) bool {
    // å…è®¸æ›´æ–°çš„å­—æ®µ
    // âœ… Image
    // âœ… Env
    // âœ… Resources (Kubernetes 1.27+)
    
    // ä¸å…è®¸æ›´æ–°çš„å­—æ®µ
    // âŒ Name
    // âŒ Ports
    // âŒ VolumeMounts
    // âŒ VolumeDevices
    // âŒ LivenessProbe
    // âŒ ReadinessProbe
    // âŒ StartupProbe
    
    if old.Name != new.Name {
        return false
    }
    
    if !apiequality.Semantic.DeepEqual(old.Ports, new.Ports) {
        return false
    }
    
    if !apiequality.Semantic.DeepEqual(old.VolumeMounts, new.VolumeMounts) {
        return false
    }
    
    // ... å…¶ä»–æ£€æŸ¥
    
    return true
}
```

## è¿›é˜¶åœºæ™¯

### 1. é‡‘ä¸é›€å‘å¸ƒï¼ˆCanary Deploymentï¼‰

```yaml
apiVersion: apps.kruise.io/v1alpha1
kind: CloneSet
metadata:
  name: nginx-canary
spec:
  replicas: 10
  updateStrategy:
    type: InPlaceIfPossible
    partition: 8  # åªæ›´æ–° 2 ä¸ª Podï¼ˆ10 - 8 = 2ï¼‰
    maxUnavailable: 1
  template:
    spec:
      containers:
      - name: nginx
        image: nginx:1.21.0  # æ–°ç‰ˆæœ¬
```

æ“ä½œæµç¨‹ï¼š

```bash
# 1. æ›´æ–° 2 ä¸ª Podï¼ˆé‡‘ä¸é›€ï¼‰
kubectl patch cloneset nginx-canary --type='merge' -p='{"spec":{"updateStrategy":{"partition":8}}}'

# 2. è§‚å¯Ÿ 2 ä¸ª Pod çš„è¡¨ç°

# 3. å¦‚æœæ­£å¸¸ï¼Œç»§ç»­æ›´æ–° 5 ä¸ª Pod
kubectl patch cloneset nginx-canary --type='merge' -p='{"spec":{"updateStrategy":{"partition":3}}}'

# 4. å…¨éƒ¨æ›´æ–°
kubectl patch cloneset nginx-canary --type='merge' -p='{"spec":{"updateStrategy":{"partition":0}}}'
```

### 2. æ‰¹é‡æ›´æ–°æ§åˆ¶

```yaml
apiVersion: apps.kruise.io/v1alpha1
kind: CloneSet
metadata:
  name: nginx-batch
spec:
  replicas: 20
  updateStrategy:
    type: InPlaceIfPossible
    maxUnavailable: 20%  # æœ€å¤šåŒæ—¶æ›´æ–° 4 ä¸ª Podï¼ˆ20 * 20% = 4ï¼‰
    maxSurge: 0          # ä¸å…è®¸è¶…å‡ºå‰¯æœ¬æ•°
    paused: false        # æ˜¯å¦æš‚åœæ›´æ–°
```

### 3. æ›´æ–°æš‚åœå’Œæ¢å¤

```bash
# æš‚åœæ›´æ–°
kubectl patch cloneset nginx-demo --type='merge' -p='{"spec":{"updateStrategy":{"paused":true}}}'

# æ¢å¤æ›´æ–°
kubectl patch cloneset nginx-demo --type='merge' -p='{"spec":{"updateStrategy":{"paused":false}}}'
```

## æœ€ä½³å®è·µ

### 1. ä½•æ—¶ä½¿ç”¨åŸåœ°å‡çº§

**é€‚ç”¨åœºæ™¯ï¼š**
- âœ… åªæ›´æ–°å®¹å™¨é•œåƒæˆ–ç¯å¢ƒå˜é‡
- âœ… éœ€è¦ä¿æŒ Pod IP ä¸å˜ï¼ˆå¦‚é•¿è¿æ¥æœåŠ¡ï¼‰
- âœ… æ•°æ®å·æŒ‚è½½äº†å¤§é‡æ•°æ®ï¼ˆé¿å…é‡æ–°æŒ‚è½½ï¼‰
- âœ… å¿«é€Ÿå›æ»š
- âœ… èµ„æºç´§å¼ çš„é›†ç¾¤

**ä¸é€‚ç”¨åœºæ™¯ï¼š**
- âŒ éœ€è¦æ›´æ–° volumesã€affinity ç­‰ä¸æ”¯æŒçš„å­—æ®µ
- âŒ Init å®¹å™¨é¢‘ç¹å˜æ›´
- âŒ éœ€è¦é‡æ–°è°ƒåº¦ Pod åˆ°å…¶ä»–èŠ‚ç‚¹

### 2. é…ç½®å¥åº·æ£€æŸ¥

```yaml
spec:
  containers:
  - name: app
    # å¯åŠ¨æ¢é’ˆï¼šç¡®ä¿å®¹å™¨æ­£ç¡®å¯åŠ¨
    startupProbe:
      httpGet:
        path: /health
        port: 8080
      failureThreshold: 30
      periodSeconds: 10
    
    # å°±ç»ªæ¢é’ˆï¼šç¡®ä¿æµé‡ä¸ä¼šæ‰“åˆ°æœªå°±ç»ªçš„ Pod
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 3
    
    # å­˜æ´»æ¢é’ˆï¼šæ£€æµ‹å®¹å™¨æ˜¯å¦å¥åº·
    livenessProbe:
      httpGet:
        path: /health
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
```

### 3. è®¾ç½®åˆç†çš„ä¼˜é›…ä¸‹çº¿æ—¶é—´

```yaml
spec:
  updateStrategy:
    inPlaceUpdateStrategy:
      gracePeriodSeconds: 30  # æ ¹æ®ä¸šåŠ¡è°ƒæ•´
  template:
    spec:
      terminationGracePeriodSeconds: 30
      containers:
      - name: app
        lifecycle:
          preStop:
            exec:
              command:
              - /bin/sh
              - -c
              - |
                # 1. åœæ­¢æ¥æ”¶æ–°è¯·æ±‚
                kill -TERM 1
                # 2. ç­‰å¾…ç°æœ‰è¯·æ±‚å¤„ç†å®Œæˆ
                sleep 15
```

### 4. ç›‘æ§å’Œå‘Šè­¦

```yaml
# Prometheus å‘Šè­¦è§„åˆ™ç¤ºä¾‹
groups:
- name: kruise
  rules:
  # åŸåœ°å‡çº§å¤±è´¥ç‡
  - alert: InPlaceUpdateFailureRateHigh
    expr: |
      rate(kruise_inplace_update_failed_total[5m]) > 0.1
    annotations:
      summary: "åŸåœ°å‡çº§å¤±è´¥ç‡è¿‡é«˜"
      
  # åŸåœ°å‡çº§è€—æ—¶è¿‡é•¿
  - alert: InPlaceUpdateDurationHigh
    expr: |
      histogram_quantile(0.99, 
        rate(kruise_inplace_update_duration_seconds_bucket[5m])
      ) > 60
    annotations:
      summary: "åŸåœ°å‡çº§è€—æ—¶è¶…è¿‡ 60 ç§’"
```

## å¯¹æ¯”æµ‹è¯•

### æµ‹è¯•åœºæ™¯ï¼šå‡çº§ 100 ä¸ª Pod

| æŒ‡æ ‡ | åŸåœ°å‡çº§ | é‡å»ºå¼å‡çº§ |
|------|---------|-----------|
| æ€»è€—æ—¶ | ~5 åˆ†é’Ÿ | ~15 åˆ†é’Ÿ |
| Pod IP å˜åŒ– | 0 | 100 |
| ç½‘ç»œæŠ–åŠ¨ | æå°‘ | è¾ƒå¤š |
| èµ„æºå ç”¨å³°å€¼ | +10% | +50% |
| å¤±è´¥ç‡ | ~1% | ~5% |

### æµ‹è¯•è„šæœ¬

```bash
#!/bin/bash

# æµ‹è¯•åŸåœ°å‡çº§æ€§èƒ½
test_inplace_update() {
    echo "å¼€å§‹æµ‹è¯•åŸåœ°å‡çº§..."
    start_time=$(date +%s)
    
    # è®°å½•åˆå§‹çŠ¶æ€
    kubectl get pods -l app=nginx-demo -o json > before.json
    
    # æ‰§è¡Œå‡çº§
    kubectl patch cloneset nginx-demo --type='merge' -p='{
      "spec": {
        "template": {
          "spec": {
            "containers": [{
              "name": "nginx",
              "image": "nginx:1.21.0"
            }]
          }
        }
      }
    }'
    
    # ç­‰å¾…å‡çº§å®Œæˆ
    kubectl wait --for=condition=Ready pods -l app=nginx-demo --timeout=300s
    
    end_time=$(date +%s)
    duration=$((end_time - start_time))
    
    # è®°å½•æœ€ç»ˆçŠ¶æ€
    kubectl get pods -l app=nginx-demo -o json > after.json
    
    # ç»Ÿè®¡ IP å˜åŒ–
    ip_changes=$(diff <(jq -r '.items[].status.podIP' before.json | sort) \
                      <(jq -r '.items[].status.podIP' after.json | sort) | wc -l)
    
    echo "å‡çº§å®Œæˆï¼"
    echo "è€—æ—¶: ${duration} ç§’"
    echo "IP å˜åŒ–æ•°: ${ip_changes}"
}

test_inplace_update
```

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. Pod ä¸€ç›´åœç•™åœ¨ Preparing çŠ¶æ€

**åŸå› ï¼š** gracePeriod è®¾ç½®è¿‡é•¿æˆ– Pod æœªæ­£ç¡®å“åº” SIGTERM

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥ Pod äº‹ä»¶
kubectl describe pod <pod-name>

# è°ƒæ•´ gracePeriod
kubectl patch cloneset nginx-demo --type='merge' -p='{
  "spec": {
    "updateStrategy": {
      "inPlaceUpdateStrategy": {
        "gracePeriodSeconds": 10
      }
    }
  }
}'
```

#### 2. åŸåœ°å‡çº§å¤±è´¥ï¼Œå›é€€åˆ°é‡å»º

**åŸå› ï¼š** æ›´æ–°äº†ä¸æ”¯æŒåŸåœ°å‡çº§çš„å­—æ®µ

**æ£€æŸ¥ï¼š**
```bash
# æŸ¥çœ‹ CloneSet äº‹ä»¶
kubectl describe cloneset nginx-demo

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -n kruise-system kruise-controller-manager-xxx | grep inplace
```

#### 3. å®¹å™¨ä¸€ç›´ CrashLoopBackOff

**åŸå› ï¼š** æ–°é•œåƒæœ‰é—®é¢˜

**è§£å†³ï¼š**
```bash
# å¿«é€Ÿå›æ»šï¼ˆåŸåœ°å›æ»šï¼‰
kubectl patch cloneset nginx-demo --type='merge' -p='{
  "spec": {
    "template": {
      "spec": {
        "containers": [{
          "name": "nginx",
          "image": "nginx:1.19.0"  # å›æ»šåˆ°æ—§ç‰ˆæœ¬
        }]
      }
    }
  }
}'
```

## æ€»ç»“

OpenKruise çš„åŸåœ°å‡çº§æ˜¯ä¸€ä¸ªå¼ºå¤§è€Œä¼˜é›…çš„åŠŸèƒ½ï¼Œå®ƒé€šè¿‡ä»¥ä¸‹æŠ€æœ¯æ‰‹æ®µå®ç°ï¼š

1. **åˆ©ç”¨ Kubernetes åŸç”Ÿèƒ½åŠ›**ï¼šå……åˆ†åˆ©ç”¨ Kubelet çš„å®¹å™¨ç®¡ç†æœºåˆ¶
2. **ç²¾å¿ƒè®¾è®¡çš„çŠ¶æ€æœº**ï¼šç¡®ä¿å‡çº§è¿‡ç¨‹å¯æ§ã€å¯è§‚æµ‹
3. **çµæ´»çš„ç­–ç•¥é…ç½®**ï¼šæ”¯æŒå¤šç§å‘å¸ƒç­–ç•¥ï¼ˆé‡‘ä¸é›€ã€æ‰¹é‡ç­‰ï¼‰
4. **ä¼˜é›…çš„æµé‡ç®¡ç†**ï¼šé€šè¿‡ ReadinessGate æ§åˆ¶æµé‡åˆ‡æ¢

é€šè¿‡åŸåœ°å‡çº§ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ï¼š
- âœ… **æ›´å¿«çš„å‡çº§é€Ÿåº¦**ï¼ˆ3-5å€æå‡ï¼‰
- âœ… **æ›´å°‘çš„èµ„æºæ¶ˆè€—**
- âœ… **æ›´ç¨³å®šçš„ç½‘ç»œè¿æ¥**
- âœ… **æ›´ç®€å•çš„è¿ç»´æ“ä½œ**

è¿™ä½¿å¾— OpenKruise æˆä¸º Kubernetes ç”Ÿæ€ä¸­ä¸å¯æˆ–ç¼ºçš„å¢å¼ºç»„ä»¶ã€‚
