---
title: pvc
createTime: 2025/09/07 15:26:29
permalink: /k8s/atnvxy1k/
---

# Kubernetes Volume挂载与PV/PVC

## Volume挂载概述

在Kubernetes中，Volume（卷）是Pod中可以被多个容器访问的共享存储。与Docker的volume不同，Kubernetes的volume具有明确的生命周期，与Pod的生命周期相同。

### Volume的主要特点：
1. **生命周期与Pod绑定**：当Pod被删除时，volume也会被清理
2. **支持多种存储类型**：本地存储、网络存储、云存储等
3. **容器间共享**：Pod内的多个容器可以共享同一个volume

## PV (PersistentVolume) 和 PVC (PersistentVolumeClaim)

### PV (PersistentVolume)
PV是集群级别的存储资源，由管理员预先配置。它代表集群中的一块存储空间，可以是：
- 本地存储
- NFS
- AWS EBS
- GCE Persistent Disk
- Azure Disk等

### PVC (PersistentVolumeClaim)
PVC是用户对存储的请求，类似于Pod对Node资源的请求。用户通过PVC来申请存储资源，Kubernetes会根据PVC的要求找到合适的PV进行绑定。

### PV和PVC的关系
```
用户创建PVC → Kubernetes匹配PV → 绑定 → Pod使用PVC
```

## 实际使用例子

### 1. 创建PV示例

```yaml
# nfs-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nfs-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 192.168.1.100
    path: /data/nfs
```

### 2. 创建PVC示例

```yaml
# nfs-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nfs-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
```

### 3. Pod使用PVC示例

```yaml
# pod-with-pvc.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-with-pvc
spec:
  containers:
  - name: nginx
    image: nginx
    volumeMounts:
    - name: nfs-storage
      mountPath: /usr/share/nginx/html
  volumes:
  - name: nfs-storage
    persistentVolumeClaim:
      claimName: nfs-pvc
```

### 4. 本地存储PV示例

```yaml
# local-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: local-pv
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: local-storage
  local:
    path: /mnt/data
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - node1
```

## 其他Volume类型的使用场景

### 1. ConfigMap Volume
用于将ConfigMap数据挂载到容器中：

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: configmap-pod
spec:
  containers:
  - name: nginx
    image: nginx
    volumeMounts:
    - name: config-volume
      mountPath: /etc/nginx/conf.d
  volumes:
  - name: config-volume
    configMap:
      name: nginx-config
```

### 2. Secret Volume
用于挂载敏感数据：

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secret-pod
spec:
  containers:
  - name: app
    image: myapp
    volumeMounts:
    - name: secret-volume
      mountPath: /etc/secrets
      readOnly: true
  volumes:
  - name: secret-volume
    secret:
      secretName: my-secret
```

### 3. EmptyDir Volume
临时存储，Pod删除时数据也会删除：

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: emptydir-pod
spec:
  containers:
  - name: writer
    image: busybox
    command: ['sh', '-c', 'echo "Hello" > /data/hello.txt; sleep 3600']
    volumeMounts:
    - name: shared-data
      mountPath: /data
  - name: reader
    image: busybox
    command: ['sh', '-c', 'cat /data/hello.txt; sleep 3600']
    volumeMounts:
    - name: shared-data
      mountPath: /data
  volumes:
  - name: shared-data
    emptyDir: {}
```

### 4. HostPath Volume
直接挂载宿主机路径：

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: hostpath-pod
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: host-storage
      mountPath: /usr/share/nginx/html
  volumes:
  - name: host-storage
    hostPath:
      path: /data
      type: DirectoryOrCreate
```

## 关键概念总结

### AccessModes（访问模式）
- **ReadWriteOnce (RWO)**：可读可写，但只能被一个节点挂载
- **ReadOnlyMany (ROX)**：只读，可被多个节点挂载
- **ReadWriteMany (RWX)**：可读可写，可被多个节点挂载

### ReclaimPolicy（回收策略）
- **Retain**：保留数据，需要手动清理
- **Delete**：自动删除PV和存储
- **Recycle**：已废弃，使用Delete替代

### StorageClass
用于动态创建PV，支持按需分配存储资源：

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp2
  fsType: ext4
```

## 最佳实践建议

1. **生产环境推荐使用StorageClass**进行动态存储分配
2. **根据应用需求选择合适的访问模式**
3. **合理设置回收策略**，避免数据丢失
4. **使用ConfigMap和Secret**管理配置和敏感信息
5. **避免使用HostPath**，除非有特殊需求
