---
title: 'ğŸ“¦CalicoåŸç†åˆ†æ'
createTime: 2025/08/12 22:03:59
permalink: /k8s/1q63pwfs/
---

kind create cluster --name calico-cluster --config - <<EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
networking:
  disableDefaultCNI: true
  podSubnet: 192.167.0.0/16
EOF

kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.30.2/manifests/tigera-operator.yaml

kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.30.2/manifests/custom-resources.yaml


cat <<EOF | calicoctl apply -f - 
---
apiVersion: projectcalico.org/v3
kind: IPPool
metadata:
  name: external-pool
spec:
  cidr: 192.168.64.0/24
  blockSize: 29
  ipipMode: Never
  natOutgoing: true
  nodeSelector: "!all()"
EOF



multipass set local.bridged-network.range=10.168.64.0/24



cat <<EOF | calicoctl apply -f -
---
apiVersion: projectcalico.org/v3
kind: BGPPeer
metadata:
  name: bgppeer-global-host1
spec:
  peerIP: 192.168.64.5
  asNumber: 64512
EOF




sudo bash -c "cat > /etc/bird/bird.conf <<EOF
router id 192.168.64.6;

protocol kernel {
    scan time 60;
    import none;
    export all;
}

protocol device {
    scan time 60;
}

protocol bgp k8s_calico {
    local as 64512;
    neighbor 172.18.0.3 as 64511;  # å°†æŒ‡å‘KindèŠ‚ç‚¹çš„IP
    import all;
    export none;
    multihop;
}
EOF"


kubectl apply -f - <<EOF
apiVersion: projectcalico.org/v3
kind: BGPPeer
metadata:
  name: multipass-peer
spec:
  peerIP: 192.168.64.6
  asNumber: 64512
  nodeSelector: all()
EOF





### **1. èŠ‚ç‚¹åŠ å…¥é›†ç¾¤**
å½“æ–°èŠ‚ç‚¹åŠ å…¥ Kubernetes é›†ç¾¤æ—¶ï¼ŒCalico ä¼šè§¦å‘è·¯ç”±å®£å‘Šï¼Œæµç¨‹å¦‚ä¸‹ï¼š
1. **èŠ‚ç‚¹æ³¨å†Œ**ï¼š
   - æ–°èŠ‚ç‚¹é€šè¿‡ `kubelet` æ³¨å†Œåˆ° Kubernetes API Serverã€‚
   - Calico çš„ `CNI æ’ä»¶` ä¸ºè¯¥èŠ‚ç‚¹åˆ†é… Pod CIDRï¼ˆå¦‚ `10.244.3.0/24`ï¼‰ã€‚
2. **Felix æ£€æµ‹å˜åŒ–**ï¼š
   - Felix ç›‘å¬ Kubernetes APIï¼Œå‘ç°æ–°èŠ‚ç‚¹åŠåˆ†é…çš„ Pod CIDRã€‚
   - Felix åœ¨æœ¬åœ°é…ç½®è·¯ç”±è¡¨ï¼Œç¡®ä¿æœ¬æœº Pod å¯è®¿é—®æ–°èŠ‚ç‚¹çš„ Pod CIDRã€‚
3. **BIRD è§¦å‘ BGP å®£å‘Š**ï¼š
   - BIRD æ£€æµ‹åˆ°æ–°è·¯ç”±ï¼ˆå¦‚ `10.244.3.0/24` å±äºæ–°èŠ‚ç‚¹ï¼‰ï¼Œé€šè¿‡ BGP åè®®å‘æ‰€æœ‰å¯¹ç­‰ä½“ï¼ˆå…¶ä»–èŠ‚ç‚¹ï¼‰å®£å‘Šè¯¥è·¯ç”±ã€‚
   - å…¶ä»–èŠ‚ç‚¹é€šè¿‡ BGP å­¦ä¹ åˆ°æ–°è·¯ç”±ï¼Œæ›´æ–°å†…æ ¸è·¯ç”±è¡¨ã€‚

**å…³é”®æ—¥å¿—**ï¼ˆé€šè¿‡ `journalctl -u bird` æŸ¥çœ‹ï¼‰ï¼š
```
BGP: Sending UPDATE to neighbor 192.168.100.3: Added 10.244.3.0/24
```

---

### **2. èŠ‚ç‚¹ç¦»å¼€æˆ–æ•…éšœ**
1. **èŠ‚ç‚¹å¤±è”**ï¼š
   - BGP ä¼šè¯å› èŠ‚ç‚¹å®•æœºæˆ–ç½‘ç»œä¸­æ–­è€Œæ–­å¼€ï¼ˆé»˜è®¤ Keepalive è¶…æ—¶ä¸º 90 ç§’ï¼‰ã€‚
2. **è·¯ç”±æ’¤å›**ï¼š
   - BIRD æ£€æµ‹åˆ°å¯¹ç­‰ä½“å¤±æ•ˆï¼Œè‡ªåŠ¨è§¦å‘ `WITHDRAW` æ¶ˆæ¯ï¼Œé€šçŸ¥å…¶ä»–èŠ‚ç‚¹æ’¤é”€è¯¥èŠ‚ç‚¹çš„è·¯ç”±ï¼ˆå¦‚ `10.244.3.0/24`ï¼‰ã€‚
3. **é›†ç¾¤æ”¶æ•›**ï¼š
   - å…¶ä»–èŠ‚ç‚¹åˆ é™¤å¤±æ•ˆè·¯ç”±ï¼Œæµé‡ä¸å†è½¬å‘è‡³æ•…éšœèŠ‚ç‚¹ã€‚

**å½±å“**ï¼š
- è‹¥æ•…éšœèŠ‚ç‚¹æ¢å¤ï¼ŒBGP ä¼šè¯é‡æ–°å»ºç«‹ï¼Œè·¯ç”±ä¼šé‡æ–°å®£å‘Šã€‚

---

### **3. Pod åˆ›å»ºæˆ–åˆ é™¤**
1. **Pod åˆ›å»º**ï¼š
   - Calico çš„ `IPAM` ä» Pod CIDR ä¸­åˆ†é… IPï¼ˆå¦‚ `10.244.1.5`ï¼‰ã€‚
   - Felix åœ¨ä¸»æœºæ·»åŠ è¯¥ Pod çš„ç›´è¿è·¯ç”±ï¼ˆæ— éœ€ BGP å®£å‘Šï¼Œå› ä¸ºå±äºæœ¬åœ° CIDRï¼‰ã€‚
2. **Pod è·¨èŠ‚ç‚¹é€šä¿¡**ï¼š
   - åªæœ‰ **Pod CIDR çš„å­ç½‘**ï¼ˆå¦‚ `10.244.1.0/24`ï¼‰ä¼šé€šè¿‡ BGP å®£å‘Šï¼Œå•ä¸ª Pod IP ä¸ä¼šå•ç‹¬å¹¿æ’­ã€‚
   - å…¶ä»–èŠ‚ç‚¹é€šè¿‡å·²å­¦ä¹ çš„ Pod CIDR è·¯ç”±ï¼Œç»“åˆä¸»æœºçš„ ARP è§£æï¼Œå®šä½å…·ä½“ Podã€‚

**ä¾‹å¤–**ï¼š
- è‹¥å¯ç”¨ `host-local` IPAM ä¸” Pod CIDR è€—å°½ï¼Œå¯èƒ½è§¦å‘æ–°èŠ‚ç‚¹åŠ å…¥ä»¥æ‰©å±•åœ°å€æ± ã€‚

---

### **4. ç½‘ç»œç­–ç•¥å˜æ›´**
1. **ç­–ç•¥æ›´æ–°**ï¼š
   - ä¿®æ”¹ `NetworkPolicy` å¯èƒ½å¯¼è‡´ Felix é‡æ–°ç”Ÿæˆ iptables/eBPF è§„åˆ™ã€‚
2. **è·¯ç”±ç­–ç•¥è°ƒæ•´**ï¼š
   - è‹¥ç­–ç•¥å½±å“è·¯ç”±ï¼ˆå¦‚ç¦æ­¢æŸäº›å­ç½‘é€šä¿¡ï¼‰ï¼ŒBIRD å¯èƒ½è§¦å‘è·¯ç”±è¿‡æ»¤æˆ–é‡æ–°å®£å‘Šã€‚
   - ä¾‹å¦‚ï¼šé€šè¿‡ `export filter` é™åˆ¶é€šå‘Šçš„è·¯ç”±èŒƒå›´ã€‚

---

### **5. æ‰‹åŠ¨å¹²é¢„**
1. **å¼ºåˆ¶è·¯ç”±åˆ·æ–°**ï¼š
   ```bash
   birdc reload  # é‡æ–°åŠ è½½ BIRD é…ç½®
   birdc disable bgp_peer  # ä¸´æ—¶ç¦ç”¨å¯¹ç­‰ä½“ï¼Œå†å¯ç”¨ä»¥è§¦å‘è·¯ç”±æ›´æ–°
   ```
2. **Calico é…ç½®å˜æ›´**ï¼š
   - ä¿®æ”¹ `BGPConfiguration`ï¼ˆå¦‚è°ƒæ•´ AS å·ã€å¯ç”¨ RR æ¨¡å¼ï¼‰ä¼šè§¦å‘å…¨é›†ç¾¤è·¯ç”±é‡æ–°åŒæ­¥ã€‚

---

### **6. å…¶ä»–åœºæ™¯**
| **åœºæ™¯**               | **è§¦å‘æ¡ä»¶**                          | **è·¯ç”±å®£å‘Šè¡Œä¸º**                     |
|-------------------------|---------------------------------------|--------------------------------------|
| **é›†ç¾¤æ‰©å®¹**           | æ–°å¢å¤šä¸ªèŠ‚ç‚¹                          | æ¯ä¸ªæ–°èŠ‚ç‚¹çš„ Pod CIDR è¢«ç‹¬ç«‹å®£å‘Š      |
| **èŠ‚ç‚¹ IP å˜æ›´**       | ä¸»æœº IP æ›´æ–°ï¼ˆå¦‚ DHCP ç»­çº¦ï¼‰          | BGP ä¼šè¯é‡å»ºï¼Œè·¯ç”±é‡æ–°å®£å‘Š            |
| **BGP å¯¹ç­‰ä½“é…ç½®å˜æ›´** | æ–°å¢/åˆ é™¤ BGP é‚»å±…ï¼ˆå¦‚ Spine-Leaf æ¶æ„ï¼‰ | åŠ¨æ€è°ƒæ•´è·¯ç”±ä¼ æ’­èŒƒå›´                  |
| **IP æ± ä¿®æ”¹**          | è°ƒæ•´ `IPPool` çš„ CIDR                 | æ‰€æœ‰å—å½±å“èŠ‚ç‚¹é‡æ–°å®£å‘Šè·¯ç”±            |

---

### **åº•å±‚åŸç†ï¼ˆBGP åè®®è§†è§’ï¼‰**
1. **è·¯ç”±æ›´æ–°æ¡ä»¶**ï¼š
   - å½“ BGP Speakerï¼ˆå¦‚ BIRDï¼‰æ£€æµ‹åˆ°æœ¬åœ°è·¯ç”±è¡¨å˜åŒ–æ—¶ï¼ˆæ–°å¢/åˆ é™¤è·¯ç”±ï¼‰ï¼Œä¼šå‘å¯¹ç­‰ä½“å‘é€ `UPDATE` æ¶ˆæ¯ã€‚
2. **æ”¶æ•›æœºåˆ¶**ï¼š
   - é»˜è®¤é‡‡ç”¨ `Full-Mesh` æ¨¡å¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç›´æ¥äº¤æ¢è·¯ç”±ã€‚
   - åœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­ï¼Œå¯é€šè¿‡ `Route Reflector (RR)` ä¼˜åŒ–ï¼Œå‡å°‘ BGP è¿æ¥æ•°ã€‚

---

### **éªŒè¯è·¯ç”±å®£å‘Š**
1. **æŸ¥çœ‹ BGP é‚»å±…çŠ¶æ€**ï¼š
   ```bash
   calicoctl node status
   # æˆ–
   birdc show protocols
   ```
2. **æ£€æŸ¥è·¯ç”±è¡¨**ï¼š
   ```bash
   ip route  # æŸ¥çœ‹å†…æ ¸è·¯ç”±è¡¨
   birdc show route  # æŸ¥çœ‹ BIRD å­¦ä¹ åˆ°çš„è·¯ç”±
   ```
3. **æŠ“åŒ…åˆ†æ**ï¼š
   ```bash
   tcpdump -i eth0 'tcp port 179'  # æ•è· BGP åè®®æµé‡
   ```

---

### **æ€»ç»“**
Calico çš„è·¯ç”±å®£å‘Šä¸»è¦ç”±ä»¥ä¸‹äº‹ä»¶è§¦å‘ï¼š
1. **èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸå˜åŒ–**ï¼ˆåŠ å…¥/ç¦»å¼€ï¼‰ã€‚
2. **Pod CIDR åˆ†é…æˆ–å›æ”¶**ã€‚
3. **BGP ä¼šè¯çŠ¶æ€å˜æ›´**ï¼ˆå¦‚å¯¹ç­‰ä½“æ–­å¼€ï¼‰ã€‚
4. **ç­–ç•¥æˆ–é…ç½®æ›´æ–°**ã€‚

è¿™ç§è®¾è®¡ç¡®ä¿äº†é›†ç¾¤ç½‘ç»œçš„ **é«˜å¯ç”¨æ€§** å’Œ **å¿«é€Ÿæ”¶æ•›**ï¼ŒåŒæ—¶é¿å…äº†ä¼ ç»Ÿ SDN æ§åˆ¶å™¨çš„å•ç‚¹ç“¶é¢ˆã€‚



åœ¨ Calico ä¸­ï¼Œ**è·¯ç”±å®£å‘Šçš„èŒè´£**ä¸»è¦ç”±ä»¥ä¸‹ç»„ä»¶åä½œå®Œæˆï¼Œä¸åŒåœºæ™¯ä¸‹ç”±ä¸åŒç»„ä»¶ä¸»å¯¼ï¼š

---

### **1. é»˜è®¤åœºæ™¯ï¼šPod ç½‘ç»œè·¯ç”±å®£å‘Š**
#### **å®£å‘Šè€…ï¼šBIRDï¼ˆBGP Clientï¼‰**
- **è§’è‰²**ï¼šCalico åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ¨ç½²çš„è½»é‡çº§ BGP å®¢æˆ·ç«¯ï¼ˆé»˜è®¤ä½¿ç”¨ BIRD æˆ– GoBGPï¼‰ã€‚
- **å·¥ä½œæµç¨‹**ï¼š
  1. **Felix** ç›‘æ§æœ¬æœº Pod å˜åŒ–ï¼Œæ›´æ–°æœ¬åœ°è·¯ç”±è¡¨ï¼ˆå¦‚ `10.244.1.0/24 via veth-host`ï¼‰ã€‚
  2. **BIRD** æ£€æµ‹åˆ°è·¯ç”±å˜åŒ–åï¼Œé€šè¿‡ BGP åè®®å‘å¯¹ç­‰ä½“ï¼ˆå…¶ä»–èŠ‚ç‚¹æˆ–å¤–éƒ¨è·¯ç”±å™¨ï¼‰å®£å‘Šè¿™äº›è·¯ç”±ã€‚
  3. å¯¹ç­‰ä½“å­¦ä¹ è·¯ç”±åï¼Œæ›´æ–°è‡ªå·±çš„è·¯ç”±è¡¨ã€‚
- **å…³é”®é…ç½®**ï¼š
  ```yaml
  # æŸ¥çœ‹ Calico çš„ BGP é…ç½®
  calicoctl get bgpconfiguration
  ```
- **æ—¥å¿—éªŒè¯**ï¼š
  ```bash
  journalctl -u bird | grep "UPDATE"  # æŸ¥çœ‹ BIRD å®£å‘Šçš„è·¯ç”±
  ```

---

### **2. ç‰¹æ®Šåœºæ™¯ï¼šService CIDR å®£å‘Šï¼ˆå®éªŒæ€§ï¼‰**
#### **å®£å‘Šè€…ï¼šCalico Node ä¸Šçš„ BIRD**
- **è§¦å‘æ¡ä»¶**ï¼šéœ€æ˜¾å¼é…ç½® `BGPConfiguration` ä¸­çš„ `serviceClusterIPs`ã€‚
- **é…ç½®ç¤ºä¾‹**ï¼š
  ```yaml
  apiVersion: projectcalico.org/v3
  kind: BGPConfiguration
  metadata:
    name: default
  spec:
    serviceClusterIPs:
      - cidr: 10.96.0.0/16  # Kubernetes Service CIDR
  ```
- **è¡Œä¸º**ï¼š
  - Calico ä¼šé€šè¿‡ BIRD å°† `10.96.0.0/16` ä½œä¸ºèšåˆè·¯ç”±å®£å‘Šå‡ºå»ã€‚
  - **æ³¨æ„**ï¼šService IP çš„è´Ÿè½½å‡è¡¡ä»ç”± `kube-proxy` æˆ– `eBPF` å¤„ç†ï¼ŒBGP ä»…è´Ÿè´£è·¯ç”±å¯è¾¾æ€§ã€‚

---

### **3. é«˜çº§åœºæ™¯ï¼šè·¯ç”±åå°„å™¨ï¼ˆRoute Reflectorï¼‰**
#### **å®£å‘Šè€…ï¼šCalico Route Reflectorï¼ˆRRï¼‰**
- **é€‚ç”¨åœºæ™¯**ï¼šå¤§è§„æ¨¡é›†ç¾¤ä¸­ï¼Œä¸ºé¿å… Full-Mesh BGP è¿æ¥è¿‡å¤šã€‚
- **è§’è‰²**ï¼š
  - ä¸“ç”¨èŠ‚ç‚¹ä½œä¸º RRï¼Œé›†ä¸­ç®¡ç†è·¯ç”±å®£å‘Šã€‚
  - å…¶ä»–èŠ‚ç‚¹ï¼ˆRR Clientï¼‰ä»…ä¸ RR äº¤æ¢è·¯ç”±ï¼Œä¸ç›´æ¥äº’è¿ã€‚
- **é…ç½®æ–¹æ³•**ï¼š
  ```bash
  # å°†æŸèŠ‚ç‚¹æ ‡è®°ä¸º Route Reflector
  calicoctl patch node node1 -p '{"spec": {"bgp": {"routeReflectorClusterID": "224.0.0.1"}}}'
  ```

---

### **4. å¤–éƒ¨ç½‘ç»œé›†æˆ**
#### **å®£å‘Šè€…ï¼šè¾¹ç•ŒèŠ‚ç‚¹ï¼ˆBorder Nodeï¼‰**
- **åœºæ™¯**ï¼šéœ€å°†é›†ç¾¤è·¯ç”±ï¼ˆPod æˆ– Serviceï¼‰å®£å‘Šåˆ°å¤–éƒ¨ç½‘ç»œï¼ˆå¦‚æ•°æ®ä¸­å¿ƒè·¯ç”±å™¨ï¼‰ã€‚
- **é…ç½®**ï¼š
  - åœ¨è¾¹ç•ŒèŠ‚ç‚¹ä¸Šé…ç½® BGP å¯¹ç­‰ï¼š
  ```yaml
  apiVersion: projectcalico.org/v3
  kind: BGPPeer
  metadata:
    name: border-router
  spec:
    peerIP: 192.168.100.254  # å¤–éƒ¨è·¯ç”±å™¨ IP
    asNumber: 65000          # å¤–éƒ¨ AS å·
  ```

---

### **ç»„ä»¶åä½œæµç¨‹å›¾**
```mermaid
flowchart TB
    Felix -->|æ›´æ–°è·¯ç”±| BIRD
    BIRD -->|BGP å®£å‘Š| OtherNodes[å…¶ä»–èŠ‚ç‚¹]
    BIRD -->|BGP å®£å‘Š| BorderRouter[è¾¹ç•Œè·¯ç”±å™¨]
    RouteReflector -->|é›†ä¸­è·¯ç”±| BIRD
    Kubernetes -->|Service CIDR| CalicoBGPConfig
```

---

### **å…³é”®æ€»ç»“**
| **è·¯ç”±ç±»å‹**       | **å®£å‘Šè€…**          | **ä¾èµ–ç»„ä»¶**       | **é…ç½®æ–¹å¼**                     |
|--------------------|---------------------|--------------------|----------------------------------|
| **Pod è·¯ç”±**       | BIRDï¼ˆæ¯ä¸ªèŠ‚ç‚¹ï¼‰    | Felix              | è‡ªåŠ¨è§¦å‘ï¼Œæ— éœ€é¢å¤–é…ç½®           |
| **Service è·¯ç”±**   | BIRDï¼ˆå®éªŒæ€§ï¼‰      | BGPConfiguration   | éœ€æ˜¾å¼å£°æ˜ `serviceClusterIPs`   |
| **å¤–éƒ¨è·¯ç”±**       | è¾¹ç•ŒèŠ‚ç‚¹çš„ BIRD     | BGPPeer            | é…ç½®å¯¹ç­‰ä½“ IP å’Œ AS å·           |
| **èšåˆè·¯ç”±**       | Route Reflector     | é›†ç¾¤æ‹“æ‰‘           | æ ‡è®°èŠ‚ç‚¹ä¸º RR                    |

---

### **å¸¸è§é—®é¢˜**
#### **Q1ï¼šä¸ºä»€ä¹ˆæˆ‘çš„ Pod è·¯ç”±æ²¡æœ‰å®£å‘Šå‡ºå»ï¼Ÿ**
- æ£€æŸ¥ BGP ä¼šè¯çŠ¶æ€ï¼š
  ```bash
  calicoctl node status
  ```
- ç¡®è®¤ BGP å·²å¯ç”¨ï¼š
  ```bash
  calicoctl get bgpconfig -o yaml
  ```

#### **Q2ï¼šService è·¯ç”±å®£å‘Šå¤±è´¥å¦‚ä½•æ’æŸ¥ï¼Ÿ**
- éªŒè¯é…ç½®ï¼š
  ```bash
  calicoctl get bgpconfiguration -o yaml
  ```
- æ£€æŸ¥ BIRD æ—¥å¿—ï¼š
  ```bash
  journalctl -u bird | grep "service"
  ```

#### **Q3ï¼šå¦‚ä½•é™åˆ¶è·¯ç”±å®£å‘ŠèŒƒå›´ï¼Ÿ**
ä½¿ç”¨ `exportFilter` è¿‡æ»¤è·¯ç”±ï¼š
```yaml
apiVersion: projectcalico.org/v3
kind: BGPConfiguration
spec:
  nodeToNodeMeshEnabled: false
  serviceClusterIPs:
    - cidr: 10.96.0.0/16
  exportFilter:
    - action: Deny
      matchExpression: '!has(10.244.0.0/16)'  # åªå…è®¸ 10.244.0.0/16 çš„è·¯ç”±
```