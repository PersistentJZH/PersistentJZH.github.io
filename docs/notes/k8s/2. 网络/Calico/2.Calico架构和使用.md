---
title: 'ğŸ±Calicoæ¶æ„å’Œä½¿ç”¨'
createTime: 2025/08/03 18:03:36
permalink: /k8s/ayl6l9u6/
---

åœ¨ Calicoï¼ˆæˆ–åŸºäº BGP çš„ç½‘ç»œæ¶æ„ï¼‰ä¸­ï¼Œè·¯ç”±å®£å‘Šçš„è§¦å‘æ¡ä»¶ä¸ç½‘ç»œæ‹“æ‰‘å˜åŒ–ã€ç­–ç•¥è°ƒæ•´æˆ–ç³»ç»Ÿäº‹ä»¶å¯†åˆ‡ç›¸å…³ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†åœºæ™¯åˆ†æåŠè§¦å‘æœºåˆ¶ï¼š

---

## **1. Calicoæ¶æ„å›¾**
<img src="../../../../.vuepress/public/architecture-calico-deae813300e472483f84d6bfb49650ab.svg" class="no-view">


---


| **ç»„ä»¶**               | **å­æ¨¡å—/æ–‡ä»¶**          | **æ ¸å¿ƒåŠŸèƒ½**                                                                 | **é…ç½®å‚æ•°ç¤ºä¾‹**                                                                 | **äº¤äº’ç»„ä»¶**                     | **å…¸å‹å·¥ä½œåœºæ™¯**                                                                 |
|------------------------|--------------------------|-----------------------------------------------------------------------------|---------------------------------------------------------------------------------|----------------------------------|---------------------------------------------------------------------------------|
| **Felix**              | `felix.cfg`              | - ç®¡ç†èŠ‚ç‚¹æœ¬åœ°è·¯ç”±è¡¨ (`route table`) <br>- é…ç½®iptables/eBPFè§„åˆ™é“¾ (`cali-INPUT`, `cali-FORWARD`ç­‰) <br>- å®æ–½ç½‘ç»œç­–ç•¥ï¼ˆæ ‡è®°æµé‡`allow/deny`ï¼‰ | `RouteRefreshInterval=10s` <br>`MetadataAddr=127.0.0.1` <br>`IptablesMarkMask=0xff000000` | BIRD, etcd/K8s API, Typha        | Podåˆ›å»ºæ—¶è‡ªåŠ¨æ·»åŠ è·¯ç”±è§„åˆ™ï¼›ç­–ç•¥æ›´æ–°æ—¶å®æ—¶ç”Ÿæ•ˆ                                      |
| **BIRD**               | `bird.cfg` (ç”±confdç”Ÿæˆ) | - é€šè¿‡BGPåè®®å¹¿æ’­æœ¬èŠ‚ç‚¹Pod CIDRï¼ˆå¦‚`10.0.1.0/24`ï¼‰<br>- å­¦ä¹ å…¶ä»–èŠ‚ç‚¹çš„è·¯ç”±ï¼ˆ`via Node2`ï¼‰                  | `protocol bgp { local as 64512; neighbor 192.168.1.2 as 64512; }`              | Felix, Route Reflector           | æ–°èŠ‚ç‚¹åŠ å…¥æ—¶è‡ªåŠ¨å»ºç«‹BGPå¯¹ç­‰è¿æ¥                                                  |
| **Calico CNI Plugin**  | `10-calico.conflist`     | - è°ƒç”¨IPAMæ’ä»¶åˆ†é…Pod IP<br>- åˆ›å»ºveth pair (`caliXXXXX`)<br>- è®¾ç½®Podç½‘ç»œå‘½åç©ºé—´è·¯ç”±                   | `"ipam": { "type": "calico-ipam", "subnet": "usePodCidr" }`                    | kubelet, IPAM, Felix             | `kubectl run`æ—¶è¢«kubeletè°ƒç”¨ï¼Œå®ŒæˆPodç½‘ç»œé…ç½®                                     |
| **calico-kube-controllers** | `policy-controller`      | - ç›‘å¬K8s `NetworkPolicy`å¹¶åŒæ­¥åˆ°Felix<br>- æ¸…ç†å­¤å„¿IPåœ°å€ï¼ˆ`IPGC`ï¼‰<br>- ç»´æŠ¤èŠ‚ç‚¹å¿ƒè·³                    | `controllers: node, policy, serviceaccount`                                     | K8s API Server, etcd             | ç”¨æˆ·åˆ›å»º`NetworkPolicy`æ—¶ï¼Œè½¬æ¢ä¸ºCalicoæ ¼å¼å¹¶ä¸‹å‘                                 |
| **Typha**              | `typha-deployment.yaml`  | - ä»£ç†Felixçš„APIè¯·æ±‚ï¼ˆç¼“å­˜`Nodes`, `Policies`ï¼‰<br>- å‡å°‘API Serverè´Ÿè½½ï¼ˆè¿æ¥æ•°ä»O(N)â†’O(1)ï¼‰             | `maxConnsPerClient=4` <br>`clientPort=5473`                                    | Felix, K8s API                   | é›†ç¾¤è¶…è¿‡50èŠ‚ç‚¹æ—¶ï¼ŒFelixé€šè¿‡Typhaè·å–ç­–ç•¥è€Œéç›´è¿API                                |
| **Route Reflector**    | `bgpconfiguration.yaml`  | - é›†ä¸­å¼è·¯ç”±åˆ†å‘ï¼ˆæ›¿ä»£å…¨äº’è”ï¼‰<br>- æ”¯æŒé›†ç¾¤ASå·ï¼ˆ`AS 64512`ï¼‰å’Œè·¯ç”±èšåˆ                                   | `routeReflectorClusterID: 1.0.0.1` <br>`logSeverityScreen: Info`               | BIRD (æ‰€æœ‰èŠ‚ç‚¹)                  | è·¨å¯ç”¨åŒºéƒ¨ç½²æ—¶ï¼Œé€šè¿‡RRé¿å…èŠ‚ç‚¹é—´ç›´æ¥BGPè¿æ¥                                       |
| **etcd/K8s API**       | `calico-config` ConfigMap | - å­˜å‚¨`IPPools`ï¼ˆ`10.0.0.0/16`ï¼‰<br>- ä¿å­˜`BGPPeers`å’Œ`NetworkPolicy`å®šä¹‰                               | `etcd_endpoints: "https://etcd:2379"` <br>`useKubernetesAPI: true`            | æ‰€æœ‰ç»„ä»¶                          | ç®¡ç†å‘˜é€šè¿‡`calicoctl`åˆ›å»ºIPæ± æ—¶å†™å…¥etcd                                           |
| **confd**              | `/etc/calico/confd`      | - ç›‘å¬etcd/K8s APIå˜æ›´ï¼ˆå¦‚`BGPPeer`æ›´æ–°ï¼‰<br>- åŠ¨æ€ç”ŸæˆBIRDé…ç½®å¹¶è§¦å‘é‡è½½                                  | `confd -watch -interval 10`                                                    | BIRD, etcd                       | BGPå¯¹ç­‰èŠ‚ç‚¹IPå˜æ›´æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°`bird.cfg`å¹¶æ‰§è¡Œ`birdc configure`                   |
| **eBPF Dataplane**     | `bpfnat`, `bpfilter`    | - æ›¿æ¢kube-proxyå®ç°Serviceè´Ÿè½½å‡è¡¡<br>- é€šè¿‡eBPF mapåŠ é€Ÿç­–ç•¥åŒ¹é…ï¼ˆ`calico_prefilter`ï¼‰                  | `bpfEnabled: true` <br>`bpfExternalServiceMode: DSR`                           | Linuxå†…æ ¸, Felix                 | é«˜æ€§èƒ½åœºæ™¯ä¸‹ï¼ŒServiceçš„DNATè§„åˆ™ç”±eBPFç¨‹åºå¤„ç†                                     |
| **WireGuard**          | `wg-cali` (æ¥å£)        | - åŠ å¯†èŠ‚ç‚¹é—´æµé‡ï¼ˆ`udp port 51820`ï¼‰<br>- æ”¯æŒPSKæˆ–è¯ä¹¦è®¤è¯                                              | `wireguardEnabled: true` <br>`wireguardListeningPort: 51820`                   | èŠ‚ç‚¹ç½‘ç»œæ ˆ                        | è·¨å…¬æœ‰äº‘éƒ¨ç½²æ—¶ï¼Œè‡ªåŠ¨å»ºç«‹åŠ å¯†éš§é“                                                  |





## **2. Calicoä½¿ç”¨**

### 1.setup kindé›†ç¾¤
```bash
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
  - role: worker
  - role: worker
networking:
  disableDefaultCNI: true
  podSubnet: 192.168.0.0/16
```

```bash
kind create cluster --name=calico-cluster --config=config.yaml
```

### 2. å®‰è£…calico
```bash
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.30.2/manifests/tigera-operator.yaml
```
```bash
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.30.2/manifests/custom-resources.yaml
```

### 3. æŸ¥çœ‹webé¡µé¢
```bash
kubectl port-forward -n calico-system service/whisker 8081:8081
```

### 4. å®‰è£…nginxæµ‹è¯•

```bash
kubectl create namespace quickstart
```
```bash
kubectl create deployment --namespace=quickstart nginx --image=nginx
```
```bash
kubectl expose --namespace=quickstart deployment nginx --port=80
```
å®‰è£…å¹¶æš´éœ²æœåŠ¡æˆåŠŸä¹‹åï¼Œåˆ›å»ºbusyboxå®¹å™¨å¹¶å¯¹nginx podè¿›è¡Œè®¿é—®
```bash
kubectl run --namespace=quickstart access --rm -ti --image busybox /bin/sh
```
æ­¤æ—¶ï¼Œé€šè¿‡podç½‘ç»œè®¿é—®é›†ç¾¤å†…nginxå’Œè®¿é—®å¤–ç½‘éƒ½èƒ½æˆåŠŸ
```bash
wget -qO- http://nginx
wget -qO- https://docs.tigera.io/pod-connection-test.txt
```

### 5. é€šè¿‡calicoå¯¹ç½‘ç»œåŠ ä¸€äº›é™åˆ¶
å¯¹è¿›ingresså’Œegresséƒ½è¿›è¡Œé™åˆ¶
```bash
kubectl create -f - <<EOF
apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: default-deny
spec:
  selector: projectcalico.org/namespace not in {'kube-system', 'calico-system', 'calico-apiserver'}
  types:
    - Ingress
    - Egress
EOF
```
åœ¨è¿›è¡Œç½‘ç»œé™åˆ¶ä¹‹åï¼Œè®¿é—®nginxå’Œå¤–ç½‘éƒ½ä¼šå¤±è´¥ã€‚
```bash
wget -qO- http://nginx
wget -qO- https://docs.tigera.io/pod-connection-test.txt
```

### 5. æŠŠç½‘ç»œæ”¾å¼€ä¸€ç‚¹
æŠŠegressæ”¾å¼€
```bash
kubectl create -f - <<EOF
apiVersion: projectcalico.org/v3
kind: NetworkPolicy
metadata:
  name: allow-busybox-egress
  namespace: quickstart
spec:
  selector: run == 'access'
  types:
  - Egress
  egress:
  - action: Allow
EOF
```
æ­¤æ—¶è®¿é—®å¤–ç½‘å¯ä»¥æˆåŠŸï¼Œä½†æ˜¯è®¿é—®nginxä¾æ—§å¤±è´¥ã€‚
```bash
wget -qO- https://docs.tigera.io/pod-connection-test.txt
wget -qO- http://nginx
```
æŠŠnginxçš„ingressæ‰“å¼€
```bash
kubectl create -f - <<EOF
apiVersion: projectcalico.org/v3
kind: NetworkPolicy
metadata:
  name: allow-nginx-ingress
  namespace: quickstart
spec:
  selector: app == 'nginx'
  types:
  - Ingress
  ingress:
  - action: Allow
    source:
      selector: run == 'access'
EOF
```
æ­¤æ—¶è®¿é—®nginxå³å¯æˆåŠŸ
```bash
wget -qO- http://nginx
```

### 6. æ¸…ç†
```bash
kind delete cluster --name calico-cluster
```
