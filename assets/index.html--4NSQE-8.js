import{_ as i,c as a,e as n,o as h}from"./app-Bx6_S8_t.js";const l={};function p(k,s){return h(),a("div",null,s[0]||(s[0]=[n(`<p>好的，这里举一个非常实用且典型的 CloneSet 使用例子：<strong>一个需要独立工作空间和原地升级的视频转码服务</strong>。</p><h3 id="场景描述" tabindex="-1"><a class="header-anchor" href="#场景描述"><span>场景描述</span></a></h3><p>假设我们有一个视频转码服务，它具有以下特点：</p><ul><li>每个转码任务在一个独立的 Pod 中运行</li><li>每个 Pod 需要 50GB 的独立工作空间来存储临时转码文件</li><li>转码过程中如果 Pod 重启，可以接受任务失败，但希望快速恢复</li><li>需要频繁更新转码器版本，希望升级时不影响正在运行的任务</li><li>客户端通过 Service 负载均衡访问，不关心具体是哪个 Pod 处理请求</li></ul><hr><h3 id="完整的-cloneset-部署示例" tabindex="-1"><a class="header-anchor" href="#完整的-cloneset-部署示例"><span>完整的 CloneSet 部署示例</span></a></h3><h4 id="_1-创建-storageclass-如果不存在" tabindex="-1"><a class="header-anchor" href="#_1-创建-storageclass-如果不存在"><span>1. 创建 StorageClass（如果不存在）</span></a></h4><div class="language-yaml" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">apiVersion</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> storage.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">kind</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> StorageClass</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">metadata</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> fast-ssd</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">provisioner</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes.io/aws-ebs</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # 或其他存储驱动</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">parameters</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  type</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gp3</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  fsType</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ext4</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  iops</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3000</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">allowVolumeExpansion</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span></code></pre></div><h4 id="_2-创建视频转码服务的-cloneset" tabindex="-1"><a class="header-anchor" href="#_2-创建视频转码服务的-cloneset"><span>2. 创建视频转码服务的 CloneSet</span></a></h4><div class="language-yaml" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">apiVersion</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apps.kruise.io/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">kind</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> CloneSet</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">metadata</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> video-transcoder</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  labels</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> video-transcoder</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">spec</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  replicas</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # 关键的更新策略：支持原地升级</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  updateStrategy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    type</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> InPlaceIfPossible</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    maxUnavailable</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    partition</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # 可以用于金丝雀发布</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # 扩缩容策略</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  scaleStrategy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    pvcRetentionPolicy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Retain</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # 缩容时保留PVC，便于调试</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # Pod 模板</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  template</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    metadata</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      labels</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> video-transcoder</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        version</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> v1.2.0</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    spec</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      containers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> transcoder</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> my-registry/video-transcoder:v1.2.0</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        env</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> POD_NAME</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          valueFrom</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            fieldRef</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">              fieldPath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> metadata.name</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> WORKSPACE_PATH</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          value</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /workspace</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # 资源请求</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        resources</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          requests</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            cpu</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 1000m</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            memory</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 2Gi</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          limits</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            cpu</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 2000m</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            memory</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 4Gi</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # 健康检查</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        livenessProbe</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          httpGet</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /health</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8080</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          initialDelaySeconds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 30</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          periodSeconds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 10</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        readinessProbe</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          httpGet</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /ready</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8080</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          initialDelaySeconds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          periodSeconds</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # 挂载工作空间</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        volumeMounts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> workspace</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          mountPath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /workspace</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          mountPath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/transcoder</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      # 初始化容器：准备workspace</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      initContainers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> init-workspace</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> busybox:latest</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        command</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sh</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-c</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        args</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          -</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> |</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            echo &quot;初始化转码工作空间...&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            mkdir -p /workspace/input</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            mkdir -p /workspace/output</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            mkdir -p /workspace/temp</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            chmod -R 755 /workspace</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            echo &quot;工作空间准备完成&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        volumeMounts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> workspace</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          mountPath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /workspace</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      # 配置卷</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        configMap</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> transcoder-config</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # 【核心】PVC模板：为每个Pod自动创建独立存储</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  volumeClaimTemplates</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> metadata</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> workspace</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    spec</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      accessModes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ReadWriteOnce</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ]</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      storageClassName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">fast-ssd</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      resources</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        requests</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          storage</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 50Gi</span></span></code></pre></div><h4 id="_3-创建-configmap-配置文件" tabindex="-1"><a class="header-anchor" href="#_3-创建-configmap-配置文件"><span>3. 创建 ConfigMap（配置文件）</span></a></h4><div class="language-yaml" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">apiVersion</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> v1</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">kind</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ConfigMap</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">metadata</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> transcoder-config</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  config.yaml</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> |</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    log_level: info</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    max_concurrent_jobs: 2</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    output_formats:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - mp4</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - webm</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - hls</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    quality_presets:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      low: &quot;480p&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      medium: &quot;720p&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      high: &quot;1080p&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  nginx.conf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> |</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    server {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        listen 8080;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        location /health {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            return 200 &#39;healthy&#39;;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        location /ready {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            return 200 &#39;ready&#39;;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    }</span></span></code></pre></div><h4 id="_4-创建-service-负载均衡" tabindex="-1"><a class="header-anchor" href="#_4-创建-service-负载均衡"><span>4. 创建 Service（负载均衡）</span></a></h4><div class="language-yaml" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">apiVersion</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> v1</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">kind</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Service</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">metadata</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> video-transcoder-service</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">spec</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  selector</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> video-transcoder</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  ports</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 80</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    targetPort</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8080</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  type</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ClusterIP</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # 或者使用 LoadBalancer 对外暴露</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # type: LoadBalancer</span></span></code></pre></div><hr><h3 id="部署和验证" tabindex="-1"><a class="header-anchor" href="#部署和验证"><span>部署和验证</span></a></h3><h4 id="_1-应用配置" tabindex="-1"><a class="header-anchor" href="#_1-应用配置"><span>1. 应用配置</span></a></h4><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> storageclass.yaml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> configmap.yaml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service.yaml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cloneset.yaml</span></span></code></pre></div><h4 id="_2-查看部署状态" tabindex="-1"><a class="header-anchor" href="#_2-查看部署状态"><span>2. 查看部署状态</span></a></h4><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看 CloneSet 状态</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cloneset</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> video-transcoder</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看 Pods（注意名称是随机的）</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pods</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -l</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> app=video-transcoder</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看自动创建的 PVCs</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pvc</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -l</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> app.kruise.io/instance=video-transcoder</span></span></code></pre></div><p><strong>输出示例：</strong></p><div class="language-" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>NAME                          READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span>video-transcoder-7x8k9        1/1     Running   0          2m</span></span>
<span class="line"><span>video-transcoder-2p5q1        1/1     Running   0          1m</span></span>
<span class="line"><span>video-transcoder-9m3n4        1/1     Running   0          30s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>NAME                                  STATUS   VOLUME                                     CAPACITY   AGE</span></span>
<span class="line"><span>workspace-video-transcoder-7x8k9     Bound    pvc-aaaa-bbbb-cccc                         50Gi       2m</span></span>
<span class="line"><span>workspace-video-transcoder-2p5q1     Bound    pvc-dddd-eeee-ffff                         50Gi       1m</span></span>
<span class="line"><span>workspace-video-transcoder-9m3n4     Bound    pvc-gggg-hhhh-iiii                         50Gi       30s</span></span></code></pre></div><hr><h3 id="cloneset-优势在这个例子中的体现" tabindex="-1"><a class="header-anchor" href="#cloneset-优势在这个例子中的体现"><span>CloneSet 优势在这个例子中的体现</span></a></h3><h4 id="_1-原地升级-核心优势" tabindex="-1"><a class="header-anchor" href="#_1-原地升级-核心优势"><span>1. <strong>原地升级（核心优势）</strong></span></a></h4><p>当需要更新转码器版本时：</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 更新镜像版本 - 触发原地升级</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> patch</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cloneset</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> video-transcoder</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --type=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">merge</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;transcoder&quot;,&quot;image&quot;:&quot;my-registry/video-transcoder:v1.2.1&quot;}]}}}}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span></code></pre></div><p><strong>原地升级的效果：</strong></p><ul><li>✅ Pod 名称不变（仍然是 <code>video-transcoder-7x8k9</code> 等）</li><li>✅ PVC 保持挂载，工作空间数据不丢失</li><li>✅ Pod IP 不变，正在进行的转码任务网络连接不中断</li><li>✅ 只重启容器，不重建整个 Pod，升级速度极快</li></ul><h4 id="_2-灵活的扩缩容" tabindex="-1"><a class="header-anchor" href="#_2-灵活的扩缩容"><span>2. <strong>灵活的扩缩容</strong></span></a></h4><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 扩容到 5 个实例</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> patch</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cloneset</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> video-transcoder</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --type=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">merge</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{&quot;spec&quot;:{&quot;replicas&quot;:5}}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 缩容到 2 个实例（保留PVC便于调试）</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> patch</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cloneset</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> video-transcoder</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --type=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">merge</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{&quot;spec&quot;:{&quot;replicas&quot;:2}}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span></code></pre></div><h4 id="_3-每个-pod-的独立工作空间" tabindex="-1"><a class="header-anchor" href="#_3-每个-pod-的独立工作空间"><span>3. <strong>每个 Pod 的独立工作空间</strong></span></a></h4><ul><li>每个转码任务在独立的空间中运行，不会相互干扰</li><li>临时文件、中间结果不会冲突</li><li>可以基于 Pod 名称在工作空间中创建子目录：<div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 在 Pod 内，可以这样组织工作空间</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/workspace/input/$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{POD_NAME}</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/workspace/output/$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{POD_NAME}</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/workspace/temp/$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{POD_NAME}</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/</span></span></code></pre></div></li></ul><h4 id="_4-高级发布策略" tabindex="-1"><a class="header-anchor" href="#_4-高级发布策略"><span>4. <strong>高级发布策略</strong></span></a></h4><div class="language-yaml" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 可以配置金丝雀发布</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">updateStrategy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  type</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> InPlaceIfPossible</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  maxUnavailable</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  partition</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # 只更新 1 个 Pod（3-2=1），另外 2 个保持旧版本</span></span></code></pre></div><hr><h3 id="实际运维操作示例" tabindex="-1"><a class="header-anchor" href="#实际运维操作示例"><span>实际运维操作示例</span></a></h3><h4 id="查看转码任务状态" tabindex="-1"><a class="header-anchor" href="#查看转码任务状态"><span>查看转码任务状态</span></a></h4><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 进入某个 Pod 查看工作空间</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> exec</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -it</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> video-transcoder-7x8k9</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ls</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -la</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /workspace</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看转码日志</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> logs</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> video-transcoder-7x8k1</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span></span></code></pre></div><h4 id="处理故障-pod" tabindex="-1"><a class="header-anchor" href="#处理故障-pod"><span>处理故障 Pod</span></a></h4><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 如果某个 Pod 故障，删除它（会自动重建）</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> delete</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pod</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> video-transcoder-7x8k9</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看新 Pod 和 PVC 的创建</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pods</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -l</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> app=video-transcoder</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -w</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pvc</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -l</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> app.kruise.io/instance=video-transcoder</span></span></code></pre></div><h4 id="监控资源使用" tabindex="-1"><a class="header-anchor" href="#监控资源使用"><span>监控资源使用</span></a></h4><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看各 Pod 的资源使用</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> top</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pods</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -l</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> app=video-transcoder</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看 PVC 使用情况</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> exec</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -it</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> video-transcoder-7x8k9</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> df</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -h</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /workspace</span></span></code></pre></div><hr><h3 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h3><p>这个视频转码服务的例子完美展示了 CloneSet + PVC 模板的适用场景：</p><p><strong>为什么不用 Deployment？</strong></p><ul><li>Deployment 无法为每个 Pod 自动创建独立存储</li><li>所有 Pod 会共享存储，导致转码文件冲突</li></ul><p><strong>为什么不用 StatefulSet？</strong></p><ul><li>不需要稳定的网络身份（客户端通过 Service 随机访问）</li><li>需要原地升级的灵活性（不中断正在进行的转码任务）</li><li>需要更灵活的扩缩容策略</li></ul><p><strong>CloneSet 的优势体现：</strong></p><ul><li>✅ <strong>独立存储</strong>：每个 Pod 有 50GB 专属工作空间</li><li>✅ <strong>原地升级</strong>：更新转码器版本不中断任务</li><li>✅ <strong>灵活伸缩</strong>：快速响应任务队列变化</li><li>✅ <strong>运维友好</strong>：PVC 保留策略便于调试</li><li>✅ <strong>资源高效</strong>：精确控制资源分配</li></ul><p>这种模式同样适用于：日志收集器、AI 模型推理服务、数据处理任务、缓存服务等需要&quot;实例级别隔离&quot;但不需要&quot;稳定网络身份&quot;的场景。</p>`,53)]))}const e=i(l,[["render",p]]),r=JSON.parse('{"path":"/k8s/7gptvl9g/","title":"cloneSet","lang":"zh-CN","frontmatter":{"title":"cloneSet","createTime":"2025/07/19 00:30:29","permalink":"/k8s/7gptvl9g/","description":"好的，这里举一个非常实用且典型的 CloneSet 使用例子：一个需要独立工作空间和原地升级的视频转码服务。 场景描述 假设我们有一个视频转码服务，它具有以下特点： 每个转码任务在一个独立的 Pod 中运行 每个 Pod 需要 50GB 的独立工作空间来存储临时转码文件 转码过程中如果 Pod 重启，可以接受任务失败，但希望快速恢复 需要频繁更新转码器...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"cloneSet\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-11-02T08:25:02.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://blog.jianzhihao.icu/k8s/7gptvl9g/"}],["meta",{"property":"og:site_name","content":"ZH Blog"}],["meta",{"property":"og:title","content":"cloneSet"}],["meta",{"property":"og:description","content":"好的，这里举一个非常实用且典型的 CloneSet 使用例子：一个需要独立工作空间和原地升级的视频转码服务。 场景描述 假设我们有一个视频转码服务，它具有以下特点： 每个转码任务在一个独立的 Pod 中运行 每个 Pod 需要 50GB 的独立工作空间来存储临时转码文件 转码过程中如果 Pod 重启，可以接受任务失败，但希望快速恢复 需要频繁更新转码器..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-11-02T08:25:02.000Z"}],["meta",{"property":"article:modified_time","content":"2025-11-02T08:25:02.000Z"}]]},"readingTime":{"minutes":4.77,"words":1431},"git":{"createdTime":1762071902000,"updatedTime":1762071902000,"contributors":[{"name":"zhihao","username":"zhihao","email":"zhihao.kan17@gmail.com","commits":1,"avatar":"https://avatars.githubusercontent.com/zhihao?v=4","url":"https://github.com/zhihao"}],"changelog":[{"hash":"dfa6bd661b3e26cc15f798b7a8c3ac2d0d60eacd","time":1762071902000,"email":"zhihao.kan17@gmail.com","author":"zhihao","message":"add cloneset"}]},"autoDesc":true,"filePathRelative":"notes/k8s/4. k8s增强/openkruise/cloneSet.md","headers":[]}');export{e as comp,r as data};
